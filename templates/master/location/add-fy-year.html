{% load static %}
<div class="modal-AddOrganisation centered">
    <div class="modal-body p-0">
        <div class="row">
            <div class="col-md-3 p-md-0" style="background-repeat: no-repeat;text-align: center;background-color: #0073e0;background-position: bottom left;background-size: 80%;">
                <div class="transformImage">
                    <img src="{% static 'img/png/townw.png' %}" class="w-30" style="width: 25% !important;" />
                    <h4 class="modalColHead">Add Financial Year</h4>
                </div>
            </div>
            <div class="col-md-9 p-md-4">
                <form id="addFinancialYearForm" method="POST" autocomplete="off" action="" aria-label="Financial Year">
                    {% csrf_token %}
                    <div class="row">
                        <div class="col-md-6">
                            <h5><b>Financial Year Details</b></h5>
                        </div>
                        <div class="col-md-6 p-md-0">
                            <button class="btn btn-save float-right" type="button" onclick="saveFinancialYear()">
                                Save
                            </button>
                            <button class="btn btn-close float-right" type="button"
                            onclick="manipulateModal('addProductModal','close')">
                            Close
                        </button>
                        </div>
                    </div>
                    <div class="row mt-md-3">

                        <div class="col-sm-6 col-6 pl-0 pr-2">
                            <input id="from_date" name="from_date" class="searchTable w-100 " placeholder="Date From*" value="{% now 'm/Y' %}" type="text" readonly >
                            <!--<img src="{% static 'img/svg/claender-grey.svg' %}" class=" calender-icon-input" style="right: 16px;" />-->
                            <label class="error_msg float-right" id=""></label>
                        </div>
                        <div class="col-sm-6 col-6  pl-1 pr-0 ">
                            <input id="to_date" name="to_date" class="searchTable w-100 " placeholder="Date To*" value="{% now 'm/Y' %}" type="text" readonly >
                            <!--<img src="{% static 'img/svg/claender-grey.svg' %}" class="calender-icon-input" />-->
                            <label class="error_msg float-right" id=""></label>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<script>

function getDateFormat(date){
    var dateTemp = date.split('/');
    date = dateTemp[2]+'-'+dateTemp[1]+'-'+dateTemp[0]
    return date
}

function validateDateRange(){
    to_date = new Date(getDateFormat($("[name='to_date']").val()));
    from_date = new Date(getDateFormat($("[name='from_date']").val()));
    $('.error_msg').text('');
    $("[name='from_date']").css("border", "");
    $("[name='to_date']").css("border", "");
    
    if(from_date > to_date ){
        $("[name='from_date']").parent().find('.error_msg').text('Start date must be less then or equal to end date');
        $("[name='from_date']").css("border", "1px solid #db8305");
        $("[name='from_date']").val('')
        return false;
    }
}

$(document).ready(function(){
    // Get the current date
    var currentDate = new Date();
    // Get the current month and year
    var currentMonth = currentDate.getMonth() + 1; // Months are zero-based
    var currentYear = currentDate.getFullYear();
    // Set the default value for the date inputs to the current month/year
    $("[name='from_date']").val(currentMonth + '/' + currentYear);
    $("[name='to_date']").val(currentMonth + '/' + currentYear);

    // Calculate the end date of the current financial year
    var endDate = new Date(currentYear, currentMonth, 0); // Last day of the current month
    // Set the max date for the date inputs to be one year from the current date
    endDate.setFullYear(endDate.getFullYear() + 10);
    
    $("[name='from_date']").datepicker({  
        changeMonth: true,
        changeYear: true,  
        //yearRange: "-100:+1",
        dateFormat: 'MM yy',
        minDate: 0,
       // maxDate: endDate, // Set the max date to one year from the current date
        dateFormat: 'mm/yy',
        onSelect: function () {
            validateDateRange();
        } 
    });
    $("[name='to_date']").datepicker({  
        changeMonth: true,
        changeYear: true,  
        //yearRange: "-100:+10",
        minDate: 0,
        dateFormat: 'MM yy',
        maxDate: endDate, // Set the max date to one year from the current date
        dateFormat: 'mm/yy',
        onSelect: function () {
            validateDateRange();
        }
    });
    
    // Function to validate the selected date range
    function validateDateRange() {
        var to_date = new Date(getDateFormat($("[name='to_date']").val()));
        var from_date = new Date(getDateFormat($("[name='from_date']").val()));
        console.log(to_date, from_date);
        $('.error_msg').text('');
        $("[name='from_date']").css("border", "");
        $("[name='to_date']").css("border", "");
    
        // Calculate the difference in milliseconds
        var timeDiff = to_date.getTime() - from_date.getTime();
    
        // Convert the difference to months
        var diffMonths = (to_date.getFullYear() - from_date.getFullYear()) * 12;
        console.log(diffMonths, 'diffMonths');

        //diffMonths -= from_date.getMonth() + 1;
        //console.log(diffMonths, 'diffMonths');

       // diffMonths += to_date.getMonth();
        console.log(diffMonths, 'diffMonths');
    
        if (diffMonths !== 12) { // Check if the difference is not exactly 12 months
            $("[name='from_date']").parent().find('.error_msg').text('The selected date range should span exactly twelve months');
            $("[name='from_date']").css("border", "1px solid #db8305");
            $("[name='from_date']").val('');
            return false;
        }
    
        // Check if start year is smaller than end year
        if (from_date.getFullYear() >= to_date.getFullYear()) {
            $("[name='from_date']").parent().find('.error_msg').text('Start year should be smaller than end year');
            $("[name='from_date']").css("border", "1px solid #db8305");
            $("[name='from_date']").val('');
            return false;
        }
    
        // Check if only one digit in the year is different
        var startYearStr = from_date.getFullYear().toString();
        var endYearStr   = to_date.getFullYear().toString();
        var diffCount    = 0;
    
        for (var i = 0; i < 4; i++) {
            if (startYearStr[i] !== endYearStr[i]) {
                diffCount++;
            }
        }
    
        if (diffCount !== 1) {
            $("[name='from_date']").parent().find('.error_msg').text('Only one digit in the year should be different');
            $("[name='from_date']").css("border", "1px solid #db8305");
            $("[name='from_date']").val('');
            return false;
        }
    
        return true; // Dates are valid
    }
    

    
});

</script>

<script>
    function saveFinancialYear() {
        showLoader();
        if (validateFinancialYearForm() && validateDateRange()) {
            hideLoader();
            return false;
        } else {
            $.ajax({
                url: "{% url 'src:add-fy-year' %}",
                method: 'POST',
                data: $('#addFinancialYearForm').serialize(),
                success: function (data) {
                    hideLoader();
                    if (data.flag) {
                        $("#addProductModal").html('');
                        $("#addProductModal").hide();
                        getList('fy_year')
                        openToaster("success", data.message);
                    } else {
                        openToaster("danger", data.message);
                    }
                },
                error: function (err) {
                    hideLoader();
                    console.log(err)
                }
            }).always(function () {
                // hideLoader();
            });
        }
    }

    function validateFinancialYearForm() {
        error = 0;
        $('.error_msg').text('');
        $('.inputField').css("border", "");
        
        //Validate start month
        var startMonth = parseInt($('[name="from_date"]').val());
        if (isNaN(startMonth) ) {
            $('.error_msg').text('Start Month should be 4');
            $('[name="from_date"]').css("border", "1px solid #db8305");
           error++;
        }
        

        // Validate end month
        var endMonth = parseInt($('[name="to_date"]').val());
        if (isNaN(endMonth) ) {
           $('.error_msg').text('End Month should be 3');
            $('[name="to_date"]').css("border", "1px solid #db8305");
            error++;
        }
        console.log(startMonth,endMonth)
        // Check if start month and end month are the same
        if (startMonth === endMonth) {
            console.log(startMonth,endMonth)

            $('.error_msg').text('Start Month and End Month should not be the same');
            $('[name="to_date"]').css("border", "1px solid #db8305");
            error++;
        }

    
        if (error > 0) {
            return true;
        } else {
            return false;
        }
    }
    
</script>
