{% extends 'layout/layout.html' %}

{% load helper_tags %}

{% block content %}

{% load static %}

{% block style %}

<style>
    .table td, .table th{
        padding:0.65rem!important;
    }
    .ui-widget.ui-widget-content{
        z-index: 999999999!important;
    }
    .ui-datepicker-prev span,
    .ui-datepicker-next span {
        background-image: none !important;
    }
    
    .ui-datepicker-prev:before,
    .ui-datepicker-next:before {
        font-family: FontAwesome;
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
        display: flex;
        font-weight: normal;
        align-items: center;
        justify-content: center;
        z-index: 999999999!important;
    }
    
    .ui-datepicker-prev:before {
        content: "\f100";
    }
    
    .ui-datepicker-next:before {
        content: "\f101";
    }
    .header{
        background-color: #0073e0;
        color: #ffffff;
    }
    
    #user_wise_order {
        width: 100%;
        height: 200px;
        border-top:1px solid rgb(223, 223, 223);
        border-left:1px solid rgb(223, 223, 223);
        border-bottom:1px solid rgb(223, 223, 223);
        box-shadow: 0px 0px 18px 0px rgba(135, 169, 224, 0.3);
    }
    
    #product_wise_order {
        width: 100%;
        height: 200px;
        border:1px solid rgb(223, 223, 223);
        box-shadow: 0px 0px 18px 0px rgba(135, 169, 224, 0.3);
    }
    #weekly {
        width: 100%;
        height: 280px;
        border:1px solid rgb(223, 223, 223);
        box-shadow: 0px 0px 18px 0px rgba(135, 169, 224, 0.3);
    }
    .select2-container--default .select2-selection--single .select2-selection__rendered{
        text-align:left!important;
    }
    
</style>

{% endblock %}

<div class="row" id="containerHeight">
    <div class="col-md-12 pr-md-0 h-100">
        <div class="primaryContainer h-100" id="mainbox">
            <div class="row mb-2" id="topRow">
                <div class="col-md-3 p-md-0">
                    <h6><b>{{page_title}} &nbsp;&nbsp;</b><span class="fa fa-star add_to_fav {% checkedFavorite page_title request.get_full_path %}" onclick="updateFavorite(this,'{{page_title}}','{{ request.get_full_path }}')"></span></h6>
                </div>
                <div class="col-md-8 p-md-0">
                    <div class="row mb-2 mt-2" id="secondRow">
                        <div class="col-md-12  text-right">
                            
                            <select class="inputField selectField" style="width: 25% !important; padding: 0.3rem;" id="user_id"onchange="getMonthList()" >
                                <option value="">All</option>
                                {% for user in user_lists %}
                                <option value="{{user.id}}">{{user.first_name}} {% if user.middle_name is not None %} {{user.middle_name}} {% endif %}{{user.last_name}} ({{user.emp_sap_id}})</option>
                                {% endfor %}
                            </select>
                            <select class="inputField selectField" style="width: 25% !important; padding: 0.3rem;" id="year" onchange="getMonthList()">
                                
                                {% for last_15_year in last_15_years %}
                                <option value="{{last_15_year}}" {% if last_15_year == present_year %}Selected
                                
                                {% else %}
                                {% endif %}>{{last_15_year}} </option>
                                {% endfor %}
                            </select>

                            </div>
                </div>
            </div>
            <div class="col-md-1"></div>
        </div>
        <div class="row" id="tableBox">
            <div class="col-md-12 primaryContainerBG h-100 p-0 commonTableBg" id="ajax-div">
                <input type="hidden" name="page" id="page" value="2" />
                <input type="hidden" name="page_status" id="page_status" value="0" />
                <input type="hidden" name="total_pages" id="total_pages" value="{{ total_pages }}" />
                <table id="addOrgTable" class="table table-borderless table-striped table-hover mt-0"
                style="width: 100%;">
                <thead>
                    <tr>
                       
                        <th class="user_name" id="user_name">
                            Months
                            <i class="fa fa-fw fa-sort float-right"></i>
                        </th>
                        <th class="regularization_type" id="regularization_type">
                            Generate/Download Salary Slip
                            <i class="fa fa-fw fa-sort float-right"></i>
                        </th>
                       
                    </tr>
                </thead>
                <tbody id="tablebody">
                  
                    
                                      
                   
                    <tr>
                        <td colspan="2" style="text-align: center;">No Record Found...</td>
                    </tr>
                 
                </tbody>
            </table>
        </div>
    </div>
</div>
</div>

<!-- *************************************Modal********************************** -->
<div class="overlayModal" id="leaveModal" data-keyboard="false" data-backdrop="static" style="display: none;"></div>
<div class="overlayModal" id="addUserModal" data-keyboard="false" data-backdrop="static">
    
</div>
<script>
      function getMonthList(){
        var user_id    = $('#user_id').val();
        var year    = $('#year').val();
        if(user_id == ''){
            openToaster("danger", "Please select at-least one Employeee");
        }else if(year == ''){
            openToaster("danger", "Please select at-least one Employeee");
        }else{ 
        
        $('#tablebody').html('<tr><td colspan="9"><div style="text-align:center"><i class="fa fa-spinner fa-spin" style="font-size:2rem"></div></td></tr>');
            $.ajax({
                url: "{% url 'src:get-month-list' %}",
                method: 'GET',
                data: { year:year,user_id:user_id},
                success: function (data) {
                    $('#tablebody').html(data);
                    $('#addOrgTable').trigger('update');
                    $('#tablebody > tr').removeAttr('class')
                },
                error: function (err) {
                    alert(err.message);
                    // window.location.reload();
                }
            });
        }
        }
    function getsalaryslip(month_no){
        var user_id    = $('#user_id').val();
        var year      = $('#year').val();
        if(user_id == ''){
            openToaster("danger", "Please select at-least one Employeee");
        }else{ 
            showLoader();
            var url = "{% url 'src:download-salary-slip-pdf' 'month_no' 'user_id' 'year' %}";
            url = url.replace('month_no',month_no).replace('user_id',user_id).replace('year',year);
            fetch(url)
            .then(response => {
                 hideLoader(); 
                // Check if the response is a PDF (content-type 'application/pdf')
              
                    // If the response is not a PDF, assume it contains a message (e.g., "No Salary Slip Data Available")
                    return response.json().then(data => {
                        hideLoader(); 
                        getMonthList()
                        // Check if the response indicates an error
                        if (data.error) {
                            // Display the error message in the toaster
                            openToaster("success", data.message);
                        } else {
                            // Display a success message in the toaster
                            openToaster("danger", data.message);
                        }
                    });
               
            })
            .catch(error => {
                hideLoader(); 
                // Handle any errors that occur during the request
                console.error('Error:', error);
                openToaster("danger", "An error occurred while retrieving the salary slip.");
            });
            
        }      
        }
    function printSalarySlip(month_no){
        var user_id    = $('#user_id').val();
        var year      = $('#year').val();
        if(user_id == ''){
            openToaster("danger", "Please select at-least one Employeee");
        }else{ 
           
            var url = "{% url 'src:print-salary-slip' 'month_no' 'user_id' 'year' %}";
            url = url.replace('month_no',month_no).replace('user_id',user_id).replace('year',year);
           
            window.location.href = url;
            
        }      
        }
        
  
</script>
{% endblock %}